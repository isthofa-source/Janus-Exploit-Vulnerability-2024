# Janus Vulnerability (CVE-2017â€“13156)

Tags: #ðŸ’¢  
Related to: 
See also: 
Previous: 
```toc
title: "## Table of Contents"
```

## Description
Janus Vulnerability (CVE-2017â€“13156) A serious vulnerability in Android allows attackers to inject a DEX file into an APK file without affecting the signatures. (i.e. modify the code in applications without affecting their signatures.)

This can be exploited due to the problem, that a Android Package file can be a valid APK file and a valid DEX file at the same time.

This problem was named as Janus, after the Roman god of duality.
Janus vulnerability comes from the possibility to add extra bytes to APK files and to DEX files.

On the one hand, anÂ **APK file**Â is a zip archive, which can contain arbitrary bytes at the start, before its zip entries (actually more generally, between its zip entries).

The JAR signature scheme only takes into account the zip entries. It ignores any extra bytes when computing or verifying the applicationâ€™s signature.

On the other hand, aÂ **DEX file**Â can contain arbitrary bytes at the end, after the regular sections of strings, classes, method definitions, etc. A file can, therefore, be a valid APK file and a valid DEX file at the same time.

In theory, the Android runtime(ART) loads the APK file, extracts its DEX file and then runs its code.

In practice, the virtual machine can load and execute both APK files and DEX files.

i.e. When it gets an APK file, it still looks at the magic bytes in the header to decide which type of file it is. If it finds a DEX header, it loads the file as a DEX file. Otherwise, it loads the file as an APK file containing a zip entry (A zip entry is a representation of each file in a zip file) with a DEX file. It can thus misinterpret dual DEX/APK files.

## Affected Versions
Currently there are 4 different signature schemes v1-v4.

- Janus affects Android devices (Android 5.0 < 8.1) when signed with v1 signature scheme.
- Applications that have been signed with APK signature scheme v2 and that are running on devices supporting the latest signature scheme (Android 7.0 and newer) are protected against the vulnerability.
- Android patch 2017 December 01 was released to fix the vulnerability on lower Android versions.

Unlike scheme v1, this scheme v2 considers all bytes in the APK file. Older versions of applications and newer applications running on older devices remain susceptible. Developers should at least always apply signature scheme v2.

## Practical Exploitation
**IMPORTANCE NOTE**
- In brief, Application that are signed **only with v1** when installed on devices having **android version(5.0â€“8.0)** are vulnerable to Janus Vulnerability.
- Application that are signed with **v1 and also v2, v3** or both when installed on devices having **android version(5.0â€“7.0)** are vulnerable to Janus Vulnerability.
- To exploit this vulnerability we need to have a device running vulnerable version of android and android patch level should be less then 2017 December 01.

In this demo we can use some APK .
![](../ALL-PICTURE/app-debug.apk)

We useÂ **apksigner**Â tool to find the signature schemes used by the application
```bash
apksigner verify -verbose app-debug.apk
```
![](../ALL-PICTURE/Pasted%20image%2020240226173222.png)
As we can see that APK has been signed with V1 and V2 signature, we will use to this application to exploit Janus Vulnerability.

Before that we need to make sure that this application can be made to run on vulnerable Android versionsÂ **5.x, 6.x and 7.x**.

let us useÂ **apktool**Â to find the min android version on which we can run this application
```bash
apktool -s d app-debug.apk && cat app-debug/apktool.yml | grep minSdk
```
![](../ALL-PICTURE/Pasted%20image%2020240226173350.png)

Application can be run on API Level 16(Android 4.1), so we can choose any device fromÂ **5.x, 6.x & 7.x**Â to exploit it.

According to Janus Vulnerability:
`A serious vulnerability in Android allows attackers to inject a DEX file into an APK file without affecting the signatures.`

So we need a dex to inject into our vulnerable application, so lets download any apk (i took another SnapChat APK file) fromÂ this:
`https://www.apkmonk.com/app/com.snapchat.android/`
 ![](../ALL-PICTURE/com.snapchat.android_2024-02-14.apk)
And extractÂ **classes.dex**Â file from theÂ **com.snapchat.android_2024-02-14.apk**Â using this command.
```bash
apktool -s d com.snapchat.android_2024-02-14.apk && mv com.snapchat.android_2024-02-14/classes.dex .
```
![](../ALL-PICTURE/Pasted%20image%2020240226174703.png)

Now, we haveÂ **classes.dex**Â file from **com.snapchat.android_2024-02-14.apk** andÂ **app-debug.apk**Â our target application.

To Inject this classes.dex file into our snapchat application, we use this exploit code: 
[janus.py](https://github.com/isthofa-source/Janus-Exploit-Vulnerability-2024/janus.py)
Copy the code and create new file namedÂ **janus.py**Â and paste into it.

Use this exploit code to inject dex file into apk.
```python
python janus.py classes.dex app-debug.apk app-debug-janusDEX.apk
```
![](../ALL-PICTURE/Pasted%20image%2020240226175229.png)  

Now, we will see how this **app-debug.apk** looks like before exploiting it. I am using Android 6.0 (API 23) as my vulnerable device to install the **app-debug** application. 
```bash
adb install app-debug.apk
```
![](../ALL-PICTURE/Pasted%20image%2020240226215442.png)  
![](../ALL-PICTURE/Pasted%20image%2020240226215517.png)  
![](../ALL-PICTURE/Pasted%20image%2020240226215630.png)  
We have seen how our vulnerable application looks like, now let us update the application with our injected apk. we can directly install the update using adb or manually by copying the injected apk into sdcard.
```bash
Direct Install   : adb install -r app-debug-janusDEX.apk
Manually Copying : adb push app-debug-janusDEX.apk /storage/emulated/0/Download
```
![](../ALL-PICTURE/Pasted%20image%2020240226220554.png)  
![](../ALL-PICTURE/Pasted%20image%2020240226220612.png)
from mobile, open file manager (In here using RootExplorer), goto Download folder and click onÂ **app-debug-janusDEX.apk**
![](../ALL-PICTURE/Pasted%20image%2020240226220737.png)  
![](../ALL-PICTURE/Pasted%20image%2020240226220809.png)  
![](../ALL-PICTURE/Pasted%20image%2020240226220854.png)  
![](../ALL-PICTURE/Pasted%20image%2020240226221001.png)  
![](../ALL-PICTURE/Pasted%20image%2020240226221020.png)  
We have successfully exploited the **app-debug.apk** application. This application is crashed, because we injected dex file of snapchat into app-debug.apk and app-debug.apk doesnâ€™t understand how to use it. DONE!! :)

And what happens if we run the application on an Android 8.0 (API 26) device where the device will not be vulnerable to janus weakness attacks according to the theory above.
```txt
Application that are signed with **v1 and also v2, v3** or both when installed on devices having **android version(5.0â€“7.0)** are vulnerable to Janus Vulnerability.
```
Here we will install and run the **app-debug.apk** application first to see if the application can run on Android 8.0 (API 26).
```bash
adb install app-debug.apk
```
![](../ALL-PICTURE/Pasted%20image%2020240226222226.png)  
![](../ALL-PICTURE/Pasted%20image%2020240226222328.png)  
![](../ALL-PICTURE/Pasted%20image%2020240226222412.png)
We have seen how our vulnerable application looks like, now let us update the application with our injected apk. we can directly install the update using adb or manually by copying the injected apk into sdcard.
```bash
Direct Install   : adb install -r app-debug-janusDEX.apk
Manually Copying : adb push app-debug-janusDEX.apk /sdcard/Download
```
![](../ALL-PICTURE/Pasted%20image%2020240226222636.png)
from mobile, open file manager, goto Download folder and click onÂ **app-debug-janusDEX.apk**
![](../ALL-PICTURE/Pasted%20image%2020240226222704.png)
![](../ALL-PICTURE/Pasted%20image%2020240226222741.png)
![](../ALL-PICTURE/Pasted%20image%2020240226222759.png)  
The application did not install successfully, it is because of the **signature V2** protection. For detailed error, we can try to install directly. 
```bash
adb install app-debug-janusDEX.apk
```
![](../ALL-PICTURE/Pasted%20image%2020240226223312.png)
Thats it :) Thanks Guys :)

## Janus Vulnerability Scanning
https://github.com/ppapadatis/python-janus-vulnerability-scan
![](../ALL-PICTURE/Pasted%20image%2020240226110355.png)


# References
[mobis3c](https://medium.com/mobis3c/exploiting-apps-vulnerable-to-janus-cve-2017-13156-8d52c983b4e0)  
[VEO's repo](https://raw.githubusercontent.com/V-E-O/PoC/master/CVE-2017-13156/janus.py)  
